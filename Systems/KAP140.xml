<?xml version="1.0"?>

<!-- KAP140 Autopilot -->
<!-- Retuned and Overhauled -->
<!-- (c) 2018 Joshua Davidson (it0uchpods) -->
<!-- License: GPL V2 -->

<PropertyList>

	<filter>
		<name>Heading Bug Error</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<property>/autopilot/settings/heading-bug-deg</property>
			<offset>
				<property>/instrumentation/heading-indicator/indicated-heading-deg</property>
				<scale>-1.0</scale>
			</offset>
		</input>
		<output>/autopilot/internal/heading-bug-error-deg</output>
		<period>
			<min>-180</min>
			<max>180</max>
		</period>
	</filter>

 <!-- =============================================================== -->
 <!-- Roll Axis Modes                                                 -->
 <!-- =============================================================== -->
	
	<pi-simple-controller>
		<name>Intercept Angle</name>
		<debug>false</debug>
		<enable>
			<condition>
				<or>
					<equals>
						<property>/autopilot/KAP140/locks/nav-hold</property>
						<value type="bool">true</value>
					</equals>
					<equals>
						<property>/autopilot/KAP140/locks/apr-hold</property>
						<value type="bool">true</value>
					</equals>
					<equals>
						<property>/autopilot/KAP140/locks/rev-hold</property>
						<value type="bool">true</value>
					</equals>
				</or>
			</condition>
		</enable>
		<input>
			<condition>
				<or>
					<equals>
						<property>/autopilot/KAP140/locks/nav-hold</property>
						<value type="bool">true</value>
					</equals>
					<equals>
						<property>/autopilot/KAP140/locks/apr-hold</property>
						<value type="bool">true</value>
					</equals>
				</or>
			</condition>
			<property>/instrumentation/nav/heading-needle-deflection-norm</property>
		</input>
		<input>
			<condition>
				<equals>
					<property>/autopilot/KAP140/locks/rev-hold</property>
					<value type="bool">true</value>
				</equals>
			</condition>
			<property>/instrumentation/nav/heading-needle-deflection-norm</property>
			<scale>-1.0</scale>
		</input>
		<reference>
			<value>0.0</value>
		</reference>
		<output>
			<property>/autopilot/KAP140/settings/target-intercept-angle</property>
		</output>
		<config>
			<Kp>-45.0</Kp>
			<Ki>-0.1</Ki>
			<min>-45.0</min>
			<max>45.0</max>
		</config>
	</pi-simple-controller>
	
	<filter>
		<name>HDG Bug/Target Turn Rate</name>
		<debug>false</debug>
		<enable>
			<property>/autopilot/KAP140/locks/hdg-hold</property>
			<value type="bool">true</value>
		</enable>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<expression>
				<table>
					<sum>
						<property>/autopilot/internal/heading-bug-error-deg</property>
						<property>/autopilot/KAP140/settings/target-intercept-angle</property>
					</sum>
					<entry><ind>-30</ind><dep>-1.00</dep></entry>
					<entry><ind>-20</ind><dep>-0.75</dep></entry>
					<entry><ind>-10</ind><dep>-0.50</dep></entry>
					<entry><ind>  0</ind><dep> 0.00</dep></entry>
					<entry><ind> 10</ind><dep> 0.50</dep></entry>
					<entry><ind> 20</ind><dep> 0.75</dep></entry>
					<entry><ind> 30</ind><dep> 1.00</dep></entry>
				</table>
			</expression>
		</input>
		<output>
			<property>/autopilot/KAP140/settings/target-turn-rate</property>
		</output>
	</filter>
	
	<filter>
		<name>Target Turn Rate Filter</name>
		<type>noise-spike</type>
		<input>/autopilot/KAP140/settings/target-turn-rate</input>
		<output>/autopilot/KAP140/settings/target-turn-rate-filtered</output>
		<max-rate-of-change>0.2</max-rate-of-change>
	</filter>
	
	<pid-controller>
		<name>Aileron Final</name>
		<debug>false</debug>
		<enable>
			<property>/autopilot/KAP140/locks/roll-axis</property>
			<value type="bool">true</value>
		</enable>
		<input>
			<property>/instrumentation/turn-indicator/indicated-turn-rate</property>
		</input>
		<reference>
			<property>/autopilot/KAP140/settings/target-turn-rate-filtered</property>
		</reference>
		<output>
			<property>/controls/flight/aileron-pid</property>
		</output>
		<config>
			<Kp>0.21</Kp>
			<Ti>10.5</Ti>
			<Td>0.01</Td>
			<u_min>-0.3</u_min>
			<u_max>0.3</u_max>
		</config>
	</pid-controller>
	
	<filter>
		<name>Aileron Servo</name>
		<enable>
			<property>/autopilot/KAP140/locks/roll-axis</property>
			<value type="bool">true</value>
		</enable>
		<type>noise-spike</type>
		<input>/controls/flight/aileron-pid</input>
		<output>/controls/flight/aileron</output>
		<max-rate-of-change>0.8</max-rate-of-change>
	</filter>

 <!-- =============================================================== -->
 <!-- Pitch Axis Modes                                                -->
 <!-- =============================================================== -->
	
	<filter>
		<name>ALT Pressure Rate</name>
		<debug>false</debug>
		<enable>
			<property>/autopilot/KAP140/locks/alt-hold</property>
			<value type="bool">true</value>
		</enable>
		<type>gain</type>
		<gain>-0.075</gain>
		<input>
			<property>/systems/static[0]/pressure-inhg[0]</property>
		</input>
		<reference>
			<property>/autopilot/KAP140/settings/target-alt-pressure</property>
		</reference>
		<output>
			<property>/autopilot/KAP140/settings/target-pressure-rate</property>
		</output>
		<min>-0.007</min>
		<max>0.007</max>
	</filter>
	
	<pid-controller>
		<name>G/S Pressure Rate</name>
		<debug>false</debug>
		<enable>
			<property>/autopilot/KAP140/locks/gs-hold</property>
			<value type="bool">true</value>
		</enable>
		<input>
			<property>/instrumentation/nav/gs-needle-deflection-norm</property>
		</input>
		<reference>
			<value>0.0</value>
		</reference>
		<output>
			<property>/autopilot/KAP140/settings/target-pressure-rate</property>
		</output>
		<config>
			<Kp>0.025</Kp>
			<Ti>20.0</Ti>
			<Td>0.0</Td>
			<u_min>0.0</u_min>
			<u_max>0.017</u_max>
		</config>
	</pid-controller>
	
	<filter>
		<name>Pressure Rate</name>
		<debug>false</debug>
		<type>derivative</type>
		<input>
			<property>systems/static[0]/pressure-inhg</property>
		</input>
		<output>
			<property>autopilot/internal/pressure-rate</property>
		</output>
		<filter-time>1.0</filter-time>
	</filter>
	
	<filter>
		<name>pressure-rate-filter</name>
		<debug>false</debug>
		<type>double-exponential</type>
		<input>
			<property>/autopilot/internal/pressure-rate</property>
		</input>
		<output>
			<property>/autopilot/internal/filtered-pressure-rate</property>
		</output>
		<filter-time>0.08</filter-time>
	</filter>
	
	<filter>
		<name>Target Pressure Rate to FPM</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>-58000</gain>
		<input>
			<property>/autopilot/KAP140/settings/target-pressure-rate</property>
		</input>
		<output>
			<property>/autopilot/KAP140/settings/target-pressure-rate-fpm</property>
		</output>
	</filter>
	
	<filter>
		<name>Target Pressure Rate Filter</name>
		<type>noise-spike</type>
		<input>/autopilot/KAP140/settings/target-pressure-rate</input>
		<output>/autopilot/KAP140/settings/target-pressure-rate-filtered</output>
		<max-rate-of-change>0.0025</max-rate-of-change>
	</filter>
	
	<pid-controller>
		<name>Elevator Final</name>
		<debug>false</debug>
		<enable>
			<property>/autopilot/KAP140/locks/pitch-axis</property>
			<value type="bool">true</value>
		</enable>
		<input>
			<property>/autopilot/internal/filtered-pressure-rate</property>
		</input>
		<reference>
			<property>/autopilot/KAP140/settings/target-pressure-rate-filtered</property>
		</reference>
		<output>
			<property>/controls/flight/elevator-pid</property>
		</output>
		<config>
			<Kp>
				<expression>
					<table>
						<abs>
							<dif>
								<property>/autopilot/internal/filtered-pressure-rate</property>
								<property>/autopilot/KAP140/settings/target-pressure-rate-filtered</property>
							</dif>
						</abs>
						<entry><ind>0.000</ind><dep> 4.5</dep></entry>
						<entry><ind>0.003</ind><dep>10.5</dep></entry>
					</table>
				</expression>
			</Kp>
			<Ti>
				<expression>
					<table>
						<abs>
							<dif>
								<property>/autopilot/internal/filtered-pressure-rate</property>
								<property>/autopilot/KAP140/settings/target-pressure-rate-filtered</property>
							</dif>
						</abs>
						<entry><ind>0.000</ind><dep>7.5</dep></entry>
						<entry><ind>0.003</ind><dep>9.0</dep></entry>
					</table>
				</expression>
			</Ti>
			<Td>0.1</Td>
			<u_min>-0.5</u_min>
			<u_max>0.5</u_max>
		</config>
	</pid-controller>
	
	<filter>
		<name>Elevator Servo</name>
		<enable>
			<property>/autopilot/KAP140/locks/pitch-axis</property>
			<value type="bool">true</value>
		</enable>
		<type>noise-spike</type>
		<input>/controls/flight/elevator-pid</input>
		<output>/controls/flight/elevator</output>
		<max-rate-of-change>0.8</max-rate-of-change>
	</filter>

</PropertyList>
